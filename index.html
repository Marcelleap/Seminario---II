<!DOCTYPE html>
<html>

<head>
    <title>Gerenciador de Disciplinas</title>
</head>

<body>
    <button id="openModalBtn" class="buttons">Editar</button>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">&times;</span>

            <form id="dateForm">
                <label for="subjectName">Disciplina:</label>
                <input type="input" id="subjectName" required>

                <label for="className">Turma:</label>
                <input type="input" id="className" required>

                <label for "institution">Instituição:</label>
                <input type="input" id="institution" required>

                <br><br>
                <label for="startDate">Início do semestre:</label>
                <input type="date" id="startDate" required>

                <label for="endDate">Fim do semestre:</label>
                <input type="date" id="endDate" required>

                <script>
                    function createClassesSchedulesForm() {
                        var classes = parseInt(document.getElementById("classes").value);
                        var container = document.getElementById("classesContainer");
                        container.innerHTML = ''; // Limpa os campos anteriores

                        for (var i = 1; i <= classes; i++) {
                            var div = document.createElement("div");
                            div.innerHTML = `
                            <label for="day${i}">Dia da semana:</label>
                            <select id="day${i}" name="days[${i}]">
                                <option value="Segunda">Segunda-feira</option>
                                <option value="Terça">Terça-feira</option>
                                <option value="Quarta">Quarta-feira</option>
                                <option value="Quinta">Quinta-feira</option>
                                <option value="Sexta">Sexta-feira</option>
                                <option value="Sábado">Sábado</option>
                                <option value="Domingo">Domingo</option>
                            </select>
                            <label for="classBeginning${i}">Hora de início:</label>
                            <input type="time" id="beginning${i}" name="classBeginning[${i}]">
                            <label for="classEnding${i}">Hora de fim:</label>
                            <input type="time" id="classEnding${i}" name="classEnding[${i}]">
                        `;
                            container.appendChild(div);
                        }
                    }
                </script>


                <br>
                <p>Quantas aulas dessa disciplina serão ministradas por semana nesta turma?</p>
                <input type="number" id="classes" name="classes" min="1" max="7">
                <input type="button" value="Criar Campos" onclick="createClassesSchedulesForm()">
            </form>

            <div id="classesContainer"></div>

            <br><br>
            <button type="button" id="generateCalendarButton">Salvar</button>
            <button type="button" id="deleteSubject">Excluir</button>

            <div id="myPopUp" class="popup">
                <div class="popup-content">
                    <span class="close" id="closePopUpBtn">&times;</span>
                    <p>Tem certeza de que deseja excluir este cadastro?</p>
                    <button id="popupDeleteConfirm">Excluir</button>
                    <button id="popupDeleteCancel">Cancelar</button>
                </div>
            </div>
        </div>
        </form>
</body>

</html>

<style>
    .buttons {
        float: right;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .popup-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
</style>

<script>
    document.getElementById('openModalBtn').addEventListener('click', function () {
        document.getElementById('myModal').style.display = 'block'
    })

    document.getElementById('closeModalBtn').addEventListener('click', function () {
        document.getElementById('myModal').style.display = 'none'
    })

    window.onclick = function (event) {
        var modal = document.getElementById('myModal')
        if (event.target == modal) {
            modal.style.display = 'none'
        }

        var buttonSave = document.getElementById('generateCalendarButton')
        if (event.target == buttonSave) {
            modal.style.display = 'none'
        }
    }

    document.getElementById('deleteSubject').addEventListener('click', function () {
        document.getElementById('myPopUp').style.display = 'block'
    })

    document.getElementById('closePopUpBtn').addEventListener('click', function () {
        document.getElementById('myPopUp').style.display = 'none'
        document.getElementById('myModal').style.display = 'none'
    })

    document.getElementById('popupDeleteConfirm').addEventListener('click', function () {
        const data = returnFromLocalStorage()
        removeFromLocalStorage(data)
        document.getElementById('myPopUp').style.display = 'none'
        document.getElementById('myModal').style.display = 'none'
    })

    document.getElementById('popupDeleteCancel').addEventListener('click', function () {
        document.getElementById('myPopUp').style.display = 'none'
        document.getElementById('myModal').style.display = 'none'
    })

    function saveSubjectFormInArray() {
        try {
            const subjectName = document.getElementById('subjectName').value
            const className = document.getElementById('className').value
            const institution = document.getElementById('institution').value
            const startDate = document.getElementById('startDate').value
            const endDate = document.getElementById('endDate').value
            const classesPerWeek = parseInt(document.getElementById('classes').value)
            const classSchedules = []

            for (let i = 1; i <= classesPerWeek; i++) {
                const dayOfWeek = document.getElementById(`day${i}`).value
                const classBeginning = document.getElementById(`beginning${i}`).value
                const classEnding = document.getElementById(`classEnding${i}`).value

                classSchedules.push({
                    dayOfWeek,
                    classBeginning,
                    classEnding,
                })
            }

            const subjectForm = {
                subjectName,
                className,
                institution,
                startDate,
                endDate,
                classesPerWeek,
                classSchedules,
            }

            saveToLocalStorage(subjectForm)

            console.log(subjectForm)

            return subjectForm
        } catch (error) {
            console.error("Erro ao armazenar informações do formulário da disciplina no array (saveSubjectFormInArray).", error)
        }
    }

    function saveToLocalStorage(data) {
        try {
            localStorage.setItem('database', JSON.stringify(data))
        } catch (error) {
            console.error('Erro ao salvar formulário da disciplina no localStorage (saveToLocalStorage).', error)
        }
    }

    function returnFromLocalStorage() {
        try {
            const data = JSON.parse(localStorage.getItem('database')) || []
            return data
        } catch (error) {
            console.error('Erro ao retornar formulário da disciplina no localStorage (returnFromLocalStorage).', error)
            return []
        }
    }

    function resetFormFields() {
        document.getElementById('subjectName').value = ''
        document.getElementById('className').value = ''
        document.getElementById('institution').value = ''
        document.getElementById('startDate').value = ''
        document.getElementById('endDate').value = ''
        document.getElementById('classes').value = ''
        document.getElementById('classesContainer').innerHTML = ''
    }

    function removeFromLocalStorage() {
        try {
            localStorage.removeItem('database')
            resetFormFields()
            generateCalendar()
        } catch (error) {
            console.error('Erro ao remover formulário da disciplina do localStorage (removeFromLocalStorage).', error)
        }
    }

    function getSemesterRange(startDate, endDate) {
        try {
            const weekdays = []
            const current = new Date(startDate)

            const endDateObj = new Date(endDate)

            endDateObj.setDate(endDateObj.getDate() + 1)

            const nextEndDate = endDateObj

            const daysOfWeek = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado']

            while (current <= endDateObj) {
                const dayOfWeek = current.getDay()
                if (dayOfWeek >= 0 && dayOfWeek <= 6) {
                    const formattedDate = `${current.getDate()}/${current.getMonth() + 1}`
                    const dayName = daysOfWeek[dayOfWeek]
                    weekdays.push({
                        dayOfMonth: formattedDate,
                        dayOfWeek: dayName,
                    })
                }
                current.setDate(current.getDate() + 1)
            }

            weekdays.shift()

            return weekdays
        } catch (error) {
            console.error("Erro ao gerar array contendo as datas do calendário (getSemesterRange).", error)
        }
    }

    function getClassesRange(subjectForm, semesterRange) {
        try {
            const classesRange = []
            const formDaysOfWeek = subjectForm.classSchedules.map(schedule => schedule.dayOfWeek)

            for (const semesterDay of semesterRange) {
                for (const formDayOfWeek of formDaysOfWeek) {
                    if (semesterDay.dayOfWeek.includes(formDayOfWeek)) {
                        const classSchedule = subjectForm.classSchedules.find(schedule => schedule.dayOfWeek === formDayOfWeek)
                        if (classSchedule) {
                            const classInfo = {
                                dayOfMonth: semesterDay.dayOfMonth,
                                dayOfWeek: semesterDay.dayOfWeek,
                                classBeginning: classSchedule.classBeginning,
                                classEnding: classSchedule.classEnding,
                            }
                            classesRange.push(classInfo)
                        }
                    }
                }
            }

            return classesRange
        } catch (error) {
            console.error("Erro ao gerar calendário da disciplina (getClassesRange).", error)
            return []
        }
    }

    function createTableWithClasses(classesRange) {
        try {
            const table = document.createElement('table')
            const thead = document.createElement('thead')
            const tbody = document.createElement('tbody')

            // Linhas da tabela com dados
            classesRange.forEach(classInfo => {
                const row = tbody.insertRow()
                const { dayOfMonth, dayOfWeek, classBeginning, classEnding } = classInfo

                const cellDayOfMonth = row.insertCell(0)
                cellDayOfMonth.textContent = dayOfMonth
                cellDayOfMonth.style.textAlign = 'center'

                const cellDayOfWeek = row.insertCell(1)
                cellDayOfWeek.textContent = dayOfWeek
                cellDayOfWeek.style.textAlign = 'center'

                const cellTime = row.insertCell(2)
                cellTime.textContent = `${classBeginning} - ${classEnding}`
                cellTime.style.textAlign = 'center'

                const cellContent = row.insertCell(3)
                const input = document.createElement('input')
                input.type = 'text'
                cellContent.appendChild(input)
                cellContent.style.textAlign = 'center'
            })

            // Cabeçalho da tabela
            if (classesRange.length > 0) {
                const headerRow = thead.insertRow()
                const headers = ['Dia do Mês', 'Dia da Semana', 'Horário', 'Conteúdo da Aula']

                headers.forEach(headerText => {
                    const th = document.createElement('th')
                    th.textContent = headerText
                    headerRow.appendChild(th)
                })
            }

            table.appendChild(thead)
            table.appendChild(tbody)

            table.style.borderCollapse = 'collapse'
            table.style.width = '100%'

            const cells = table.getElementsByTagName('td')
            for (let i = 0; i < cells.length; i++) {
                cells[i].style.border = '1px solid #dddddd'
                cells[i].padding = '8px'
            }

            return table
        } catch (error) {
            console.error("Erro ao criar tabela da disciplina (createTableWithClasses).", error)
        }
    }

    function fillFormFields(savedData) {
        document.getElementById('subjectName').value = savedData.subjectName
        document.getElementById('className').value = savedData.className
        document.getElementById('institution').value = savedData.institution
        document.getElementById('startDate').value = savedData.startDate
        document.getElementById('endDate').value = savedData.endDate

        const classesPerWeek = savedData.classesPerWeek
        document.getElementById('classes').value = classesPerWeek
        createClassesSchedulesForm();

        for (let i = 1; i <= classesPerWeek; i++) {
            document.getElementById(`day${i}`).value = savedData.classSchedules[i - 1].dayOfWeek
            document.getElementById(`beginning${i}`).value = savedData.classSchedules[i - 1].classBeginning
            document.getElementById(`classEnding${i}`).value = savedData.classSchedules[i - 1].classEnding
        }
    }

    window.addEventListener('load', function () {
        const savedData = returnFromLocalStorage()
        if (savedData) {
            fillFormFields(savedData)
            generateCalendar()
        }
    });

    function generateCalendar() {
        const subjectForm = saveSubjectFormInArray()
        const startDate = new Date(subjectForm.startDate)
        const endDate = new Date(subjectForm.endDate)
        const semesterRange = getSemesterRange(startDate, endDate)
        const classesRange = getClassesRange(subjectForm, semesterRange)

        const existingTable = document.getElementById('calendarTable')
        if (existingTable) {
            existingTable.remove()
        }

        const table = createTableWithClasses(classesRange)
        table.id = 'calendarTable'
        document.body.appendChild(table)
    }

    function main() {
        const generateCalendarButton = document.getElementById('generateCalendarButton')
        generateCalendarButton.addEventListener('click', generateCalendar)
    }

    main()

</script>
